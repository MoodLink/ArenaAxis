version: '3.8'

services:
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: arenaaxis-gateway:latest
    container_name: arenaaxis-gateway
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - USER_SERVICE_URL=http://user-service:8081
      - MESSAGE_SERVICE_URL=http://message-service:8082
      - ORDER_SERVICE_URL=http://order-service:3000
      - MESSAGE_SERVICE_WS_URL=ws://message-service:8082
    depends_on:
      - user-service
      - message-service
      - order-service
    networks:
      - arena-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    image: arenaaxis-user-service:latest
    container_name: arenaaxis-user-service
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - MYSQL_URL=${MYSQL_URL}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ORDER_SERVICE_URL=http://order-service:3000
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    networks:
      - arena-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8081 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  message-service:
    build:
      context: ./message-service
      dockerfile: Dockerfile
    image: arenaaxis-message-service:latest
    container_name: arenaaxis-message-service
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - MESSAGE_MONGODB_URL=${MESSAGE_MONGODB_URL}
      - MESSAGE_MONGODB_DATABASE=${MESSAGE_MONGODB_DATABASE}
      - USER_SERVICE_URL=http://user-service:8081
    networks:
      - arena-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8082 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    image: arenaaxis-order-service:latest
    container_name: arenaaxis-order-service
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MONGO_URL=${MONGO_URL}
      - PAYOS_CLIENT_ID=${PAYOS_CLIENT_ID}
      - PAYOS_API_KEY=${PAYOS_API_KEY}
      - PAYOS_CHECKSUM_KEY=${PAYOS_CHECKSUM_KEY}
      - USER_SERVICE_URL=http://user-service:8081
      - PORT=${PORT}
      - RETURN_URL=${RETURN_URL}
      - CANCEL_URL=${CANCEL_URL}
    networks:
      - arena-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  arena-network:
    driver: bridge