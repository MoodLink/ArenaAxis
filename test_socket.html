<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Message Service Tester</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    input, button, textarea, select { padding:8px; font-size:14px; }
    input[type="text"]{width:220px;}
    textarea { width:100%; height:160px; resize:vertical; }
    .box { border:1px solid #ddd; padding:12px; border-radius:6px; background:#fafafa; }
    .log { height:260px; overflow:auto; background:#111; color:#eee; padding:8px; border-radius:6px; font-family: monospace; font-size:13px; }
    .status { font-weight:600; }
    .green { color: #0a0; } .red { color:#a00; } .orange { color:#e67e22; }
  </style>
</head>
<body>
  <h2>WS Message Service Tester</h2>

  <div class="box">
    <!-- URL + Token -->
    <div class="row">
      <label for="wsUrl">WebSocket URL</label>
      <input id="wsUrl" type="text" value="ws://localhost:8082/ws/messages" />

      <label for="tokenInput">Token</label>
      <input id="tokenInput" type="text" placeholder="JWT token..." style="width:260px" />

      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
      <span class="status" id="connStatus"><span class="red">DISCONNECTED</span></span>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:12px;">
      <div style="flex:1">
        <div class="row">
          <label for="myUserId">My userId</label>
          <input id="myUserId" type="text" placeholder="user123" />
          <button id="registerBtn" disabled>Register (send)</button>
        </div>

        <div style="margin-top:8px;">
          <label for="sendReceiver">To (receiverId)</label>
          <input id="sendReceiver" type="text" placeholder="receiverId" />
        </div>

        <div style="margin-top:8px;">
          <label for="messageText">Message</label>
          <input id="messageText" type="text" placeholder="Hello!" />
        </div>

        <div style="margin-top:8px;">
          <button id="sendBtn" disabled>Send Message</button>
          <button id="sendRawBtn" disabled>Send Raw JSON</button>
        </div>
      </div>

      <div style="width:340px;">
        <div><strong>Last outgoing JSON</strong></div>
        <textarea id="lastOutgoing" readonly></textarea>
      </div>
    </div>

    <div>
      <strong>Logs / Received messages</strong>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const urlInput = document.getElementById('wsUrl');
    const tokenInput = document.getElementById('tokenInput');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const connStatus = document.getElementById('connStatus');

    const myUserIdInput = document.getElementById('myUserId');
    const registerBtn = document.getElementById('registerBtn');

    const receiverInput = document.getElementById('sendReceiver');
    const messageInput = document.getElementById('messageText');
    const sendBtn = document.getElementById('sendBtn');
    const sendRawBtn = document.getElementById('sendRawBtn');

    const lastOutgoing = document.getElementById('lastOutgoing');
    const log = document.getElementById('log');

    let ws = null;

    function logLine(level, text) {
      const time = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.textContent = `[${time}] ${text}`;

      if (level === 'in') el.style.color = '#8fd19e';
      if (level === 'out') el.style.color = '#9ec7ff';
      if (level === 'err') el.style.color = '#ff9e9e';

      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    }

    function setStatus(connected) {
      if (connected) {
        connStatus.innerHTML = '<span class="green">CONNECTED</span>';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        registerBtn.disabled = false;
        sendBtn.disabled = false;
        sendRawBtn.disabled = false;
      } else {
        connStatus.innerHTML = '<span class="red">DISCONNECTED</span>';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        registerBtn.disabled = true;
        sendBtn.disabled = true;
        sendRawBtn.disabled = true;
      }
    }

    connectBtn.addEventListener('click', () => {
      let url = urlInput.value.trim();
      const token = tokenInput.value.trim();

      if (!url.startsWith("ws://") && !url.startsWith("wss://")) {
        return alert("URL phải bắt đầu bằng ws:// hoặc wss://");
      }

      if (token) {
        url += "?token=" + encodeURIComponent(token);
      }

      ws = new WebSocket(url);

      ws.onopen = () => {
        setStatus(true);
        logLine('in', `Connected to ${url}`);
      };

      ws.onmessage = evt => {
        try {
          const data = JSON.parse(evt.data);
          logLine('in', `RECV: ${JSON.stringify(data)}`);
        } catch {
          logLine('in', `RECV: ${evt.data}`);
        }
      };

      ws.onclose = ev => {
        setStatus(false);
        logLine('err', `Disconnected (code=${ev.code})`);
        ws = null;
      };

      ws.onerror = () => {
        logLine('err', 'WebSocket error');
      };
    });

    disconnectBtn.addEventListener('click', () => {
      if (ws) ws.close();
    });

    registerBtn.addEventListener('click', () => {
      const userId = myUserIdInput.value.trim();
      if (!userId) return alert('Nhập my userId trước khi register');

      const payload = { type: 'register', userId };
      const s = JSON.stringify(payload);
      ws.send(s);
      lastOutgoing.value = s;
      logLine('out', `SENT (register) ${s}`);
    });

    sendBtn.addEventListener('click', () => {
      const myUserId = myUserIdInput.value.trim();
      const to = receiverInput.value.trim();
      const text = messageInput.value;

      if (!myUserId) return alert('Nhập userId và register trước');
      if (!to) return alert('Nhập receiverId');

      const payload = {
        type: 'message.send',
        data: {
          senderId: myUserId,
          receiverId: to,
          content: text
        }
      };
      const s = JSON.stringify(payload);
      ws.send(s);
      lastOutgoing.value = s;
      logLine('out', `SENT (message) ${s}`);
    });

    sendRawBtn.addEventListener('click', () => {
      const raw = prompt('Nhập raw JSON payload');
      if (!raw) return;

      try { JSON.parse(raw); } 
      catch { return alert('JSON không hợp lệ'); }

      ws.send(raw);
      lastOutgoing.value = raw;
      logLine('out', `SENT (raw) ${raw}`);
    });

    // tự động register khi mất focus
    myUserIdInput.addEventListener('blur', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const uid = myUserIdInput.value.trim();
        if (!uid) return;

        const payload = { type: 'register', userId: uid };
        const s = JSON.stringify(payload);
        ws.send(s);
        lastOutgoing.value = s;
        logLine('out', `SENT (auto-register) ${s}`);
      }
    });

    setStatus(false);
  </script>

</body>
</html>
