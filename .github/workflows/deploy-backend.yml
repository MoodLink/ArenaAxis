name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '!backend/README.md'
      - '!backend/**/*.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: services
        run: |
          echo "ðŸ” Detecting changed services..."

          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^backend/' || echo "")

          if [ -z "$CHANGED" ]; then
            echo "âš ï¸ No backend files changed"
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED"
          echo ""

          SERVICES=""

          if echo "$CHANGED" | grep -q "backend/gateway/"; then
            SERVICES="$SERVICES gateway"
          fi

          if echo "$CHANGED" | grep -q "backend/user-service/"; then
            SERVICES="$SERVICES user-service"
          fi

          if echo "$CHANGED" | grep -q "backend/message-service/"; then
            SERVICES="$SERVICES message-service"
          fi

          if echo "$CHANGED" | grep -q "backend/order-service/"; then
            SERVICES="$SERVICES order-service"
          fi

          if echo "$CHANGED" | grep -q "backend/docker-compose.yml"; then
            echo "âš ï¸ docker-compose.yml changed â†’ deploy all services"
            SERVICES="gateway user-service message-service order-service"
          fi

          SERVICES=$(echo $SERVICES | xargs)

          if [ -z "$SERVICES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          fi

      - name: Upload backend files
        if: steps.services.outputs.changed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VULTR_HOST }}
          username: ${{ secrets.VULTR_USER }}
          key: ${{ secrets.VULTR_SSH_KEY }}
          source: "backend/*"
          target: "~/project/ArenaAxis"
          timeout: 5m

      - name: Deploy services with auto-rollback
        if: steps.services.outputs.changed == 'true'
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 20
        env:
          SERVICES: ${{ steps.services.outputs.services }}
          COMMIT_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        with:
          host: ${{ secrets.VULTR_HOST }}
          username: ${{ secrets.VULTR_USER }}
          key: ${{ secrets.VULTR_SSH_KEY }}
          envs: SERVICES,COMMIT_SHA,GITHUB_ACTOR,GITHUB_RUN_ID
          command_timeout: 20m
          script: |
            #!/bin/bash
            set -e

            cd ~/project/ArenaAxis/backend

            # Load env safely
            if [ -f .env ]; then
              set -a
              source .env
              set +a
            fi

            mkdir -p .deploy/backup .deploy/logs
            LOG_FILE=".deploy/logs/deploy_${GITHUB_RUN_ID}.log"

            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
            }

            rollback() {
              log "âŒ DEPLOY FAILED â†’ ROLLBACK"
              for svc in $DEPLOYED_SERVICES; do
                if [ -f .deploy/backup/${svc}.id ]; then
                  OLD_IMAGE=$(cat .deploy/backup/${svc}.id)
                  docker tag $OLD_IMAGE arenaaxis-${svc}:latest || true
                  docker compose up -d $svc || true
                fi
              done
              docker compose ps | tee -a "$LOG_FILE"
              exit 1
            }

            trap rollback ERR
            DEPLOYED_SERVICES=""

            log "ðŸš€ Deploying services: $SERVICES"

            for svc in $SERVICES; do
              log "ðŸ“¦ $svc"

              CURRENT_IMAGE=$(docker compose images -q $svc || true)
              if [ -n "$CURRENT_IMAGE" ]; then
                echo "$CURRENT_IMAGE" > .deploy/backup/${svc}.id
              fi

              docker compose build $svc | tee -a "$LOG_FILE"
              docker tag arenaaxis-${svc}:latest arenaaxis-${svc}:${COMMIT_SHA} || true
              docker compose up -d $svc | tee -a "$LOG_FILE"

              DEPLOYED_SERVICES="$DEPLOYED_SERVICES $svc"

              ATTEMPTS=0
              while [ $ATTEMPTS -lt 12 ]; do
                sleep 5
                if docker compose ps $svc | grep -q "Up"; then
                  break
                fi
                ATTEMPTS=$((ATTEMPTS + 1))
              done

              if [ $ATTEMPTS -eq 12 ]; then
                docker compose logs --tail=50 $svc | tee -a "$LOG_FILE"
                exit 1
              fi

              echo "$COMMIT_SHA" > .deploy/${svc}.version
              log "âœ… $svc deployed"
            done

            log "ðŸŽ‰ DEPLOY SUCCESS"
            docker compose ps | tee -a "$LOG_FILE"

      - name: Notification on failure
        if: failure()
        run: |
          echo "::error::Deployment failed"
          echo "Services: ${{ steps.services.outputs.services }}"
